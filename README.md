# Тестовое задание

## Демо-версия

[Демо-версия](https://test-excel.herokuapp.com/) приложения размещена на [Heroku](https://www.heroku.com/).

## Описание

Нужно сделать небольшой сайт.
При входе на сайт мы видим пустую таблицу 5 на 5 ячеек. В каждую ячейку мы можем вводить текстовые строки.
Под таблицей (или в меню, или еще где-то) есть следующие кнопки:

1. **Изменить размер таблицы**. При нажатии на нее мы можем указать новое кол-во столбцов и строк и применить изменения. При этом размер таблицы меняется на новый, а введенные данные, если они есть, сохраняются в тех ячейках, которые остались после изменения.
1. **Импортировать из CSV-файла**. При нажатии выбираем файл и загружаем. При этом на основе данных создается новая таблица с данными нужного размера. Старые данные теряются.
1. **Экспортировать в CSV-файл**. При нажатии сохраняем введенные данные в файл.
1. **Рассчитать**. При этом обрабатывается содержимое таблицы и ниже выводится результат – вторая таблица такого же размера с полученными данными расчетов (описано ниже).

### Расчеты

В ячейках таблицы могут быть либо вещественные числа, либо формулы.
Формулы могут содержать четыре математические операции: +, -, * и /, скобки, а также числа и/или номера ячеек (по аналогии с Excel). Приоритеты операций нужно соблюдать.
Например, содержимое ячеек может быть следующим:

1. 123
1. 7.55
1. 3+7
1. 22*3-10
1. А1*20+А2/А3
1. (1+2)/(4-1)

Нужно обработать значения ячеек и в таблице с результатом вывести рассчитанные значения.
Если значение из исходной таблицы в какой-то ячейке не может быть обработано, то нужно подкрасить ячейку красным цветом.
При этом в таблице с результатом в соответствующей ячейке нужно вывести причину ошибки.
Должна быть возможность экспортировать в CSV-файл таблицу с результатом вычислений.

Например, для исходной таблицы размером 2 на 2.

#### Вход

|| A | B |
| :---: | :---: | :---: |
| 1 | 7 | A1-1 |
| 2 | A1+B1 | A2-1 |

#### Выход

|| A | B |
| :---: | :---: | :---: |
| 1 | 7 | 6 |
| 2 | 13 | 12 |

При этом для парсинга и расчета формул нельзя использовать регулярки, сторонние библиотеки и т.п. Алгоритм разбора формул нужно написать самому.

## Инструментарий

Сделано на Angular 8 c использованием следующих библиотек:

* Handsontable - для реализации таблиц
* Angular Material - элементы UI
* Papaparse - парсинг CSV
* ngx-mat-file-input - input для загрузки файла

## Описание приложения

По умолчанию доступна для взаимодействия таблица 5х5.

### Валидация

Осуществляется валидация вводимых в ячейки значений с помощью регулярного выражения - разрешено вводить только цифры, латинские буквы, скобки и знаки операций. Если в ячейку будет введено неверное значение, отобразится окно с предупреждением.

### Изменение размера таблицы

Доступно изменение количества столбцов и строк таблицы. По умолчанию, максимальный размер таблицы - 20х20.

### Импорт из CSV-файла

Парсинг CSV реализован с помощью библиотеки Papaparse. Приложение позволяет импортировать CSV файлы с разделителями `,` и `;`. Также возможен импорт TSV файлов.

### Экспорт в CSV-файл

Реализован экспорт данных, введенных в таблицу, в CSV файл.

### Рассчет

Реализована возможность рассчета введенных в таблицу выражений

### Обработка выражений в ячейках

1. Содержимое ячейки (строка) разбивается на токены (массив строк, элементы которого - числа/ссылки и операции/скобки). Если ячейка пуста (или содержит лишь пробелы), ее содержимое трактуется как "0".
1. Осуществляется предварительная обработка ячейки - удаляются пробелы, буквы, если они есть, конвертируются в заглавные.
1. Далее строка конвертируется в форму [обратной польской записи](https://ru.wikipedia.org/wiki/%D0%9E%D0%B1%D1%80%D0%B0%D1%82%D0%BD%D0%B0%D1%8F_%D0%BF%D0%BE%D0%BB%D1%8C%D1%81%D0%BA%D0%B0%D1%8F_%D0%B7%D0%B0%D0%BF%D0%B8%D1%81%D1%8C). Для реализации этой конвертации используется [алгоритм сортировочной станции](https://ru.wikipedia.org/wiki/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC_%D1%81%D0%BE%D1%80%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%BE%D1%87%D0%BD%D0%BE%D0%B9_%D1%81%D1%82%D0%B0%D0%BD%D1%86%D0%B8%D0%B8). Для каждой ячейки создается ОПЗ-версия выражения, которое она содержит.
1. Далее производится обработка ссылочных значений - запрашивается значение ячейки по ссылке:
    * Если рассчет запрашиваемой ячейки был завершен, ссылка в исходном выражении заменяется на число. Если после этого в выражении еще остались ссылки, переходим к обработке следующей ссылки. Если ссылок больше не осталось - ячейка помечается как готовая к расчету.
    * Если расчет ячейки еще не завершен - пока пропускаем эту ячейку.
    * Если такой ячейки не существует, или ячейка ссылается сама на себя - выдается ошибка.
1. Когда ячейка помечена как готовая к расчету, осуществляется расчет ее значения на основании полученной ОПЗ-версии выражения.

Возможна ситуация, когда 2 и более ячеек ссылаются друг на друга, что делает расчет результата невозможным. Обработка данной ошибки реализована следующий образом - если расчет результата не удается завершить за установленное число итераций (по умолчанию - 50), ячейки, которые не удалось рассчитать, помечаются соответствующей ошибой.

После того, как расчет результата завершен, значение ячейки отображается в соответствующей ячейке в таблице результата. Если возникла ошибка, в ячейку записывается описание ошибки, а исходная ячейка в первоначальной таблице помечается красным цветом. 

Результат расчета можно экспортировать в CSV файл (функционал аналогичен таковому для исходной таблицы)
